<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="author" content="Nicolas Chourot">
        <meta name="description" content="Object Oriented form validation">
        <title>Formulaire de création de compte</title>
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <style>
            .groupBox {
                border: 1px solid lightgrey;
                border-radius: 8px;
                padding: 12px;
            }
            .groupBoxLegend {
                color:grey;
                font-size: medium;
            }
            .radioButtonLabel {
                margin: 6px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div id="subscribeFormPanel" class="form-group col-md-4" style="max-width: 330px">
                <h3>Création de compte</h3>
                <hr/>
                <!-- le code du formulaire est inséré ici par programmation -->
            </div>
        </div>


<script>
    "use strict";
    //////////////////////////////////////////////////////////////////////////////////////////////////////
    //
    // Ce script a été développé dans un contexte pédagogique et représente nullement une solution
    // professionnelle complète.
    //
    // L'objectif pédagogique de ce code est de démontrer les techniques suivantes:
    //
    // - Injection de balises par programmation
    // - Installation de gestionnaires d'événement
    // - Automatisation de mécanisme de validation
    // - filtre de champ texte
    // - POO en JavaScript
    //
    // Auteur: Nicolas Chourot
    // 18 nov 2018 - Mise à jour 10 janvier 2019
    //
    //
    // Note importante:
    //
    // la validation de formulaire peut-être entièrement et très efficacement réalisée avec
    // la librairie CSS Bootstap 3.0 et ne requière pas de programmation Javascript/DOM
    // voir démo: https://codepen.io/jaycbrf/pen/iBszr . Par contre on ne pourra pas créer des
    // méthodes de validation particulières comme par exemple faire une requête http vers un serveur
    // pour vérifier l'existence d'un usager.
    //
    // Le script ci-dessous a le mérite d'être qu'en JavaScript "pur" libre de bibliothèque
    // mise à par quelques classes de base de Bootstrap tel que col-md, btn btn-group, form-control, etc.
    //
    ///////////////////////////////////////////////////////////////////////////////////////////////////////

    //
    // Ajouter à element les classes séparées par un espace contenues dans cssClass
    //
    function addClass(element, cssClass) {
        let css = cssClass.split(" ");
        css.forEach(item => {element.classList.add(item)});
    }

    //
    // <div id='elementId' class="cssClass"> </div>
    //
    function makeDiv(elementId, cssClass){
        let div = document.createElement('div');
        div.id = elementId;
        addClass(div, cssClass);
        return div;
    }

    //
    // <label for="targetElementId" class="cssClass">text</label>
    //
    function makeLabelFor(targetElementId, text, cssClass){
        let label = document.createElement('label');
        label.htmlFor = targetElementId;
        label.textContent = text;
        addClass(label, cssClass);
        return label;
    }

    //
    // <input type"text" name="name" id="name" placeholder="placeHolder class="cssClass" />
    //
    function makeTextBox(name, placeHolder, cssClass){
        let textBox = document.createElement('input');
        textBox.type ="text";
        textBox.name = name;
        textBox.id = name;
        textBox.placeholder = placeHolder;
        addClass(textBox, cssClass);
        return textBox;
    }

    //
    // <input type"password" name="name" id="name" placeholder="placeHolder class="cssClass" />
    //
    function makePasswordBox(name, placeHolder, cssClass){
        let textBox = document.createElement('input');
        textBox.type ="password";
        textBox.name = name;
        textBox.id = name;
        textBox.placeholder = placeHolder;
        addClass(textBox, cssClass);
        return textBox;
    }

    //
    // <input type="radio" name="name" id="name_index" value="value" class="cssClass" />
    //
    function makeRadioButton(name, index, value, cssClass) {
        let radioButton = document.createElement('input');
        radioButton.type = "radio";
        radioButton.name = name;
        radioButton.value = value;
        radioButton.id = name + "_" + index;
        addClass(radioButton, cssClass);
        return radioButton;
    }

    //
    // <legend class="cssClass"> text </legend>
    //
    function makeLegend(text, cssClass){
        let legend = document.createElement('legend');
        legend.textContent = text;
        addClass(legend, cssClass);
        return legend;
    }

    //
    // <div id="nameGroup" class="groupBox">
    //      <fieldset>
    //          <legend class="groupBoxLegend">title<legend/>
    //          <input type="radio" name="name" id="name_0" value="radioButtonValues[0]" class="check-box" />
    //          <label for="name_0" class="cssClass">radioButtonValues[0]</label>
    //          <input type="radio" name="name" id="name_1" value="radioButtonValues[1]" class="check-box" />
    //          <label for="name_1" class="cssClass">radioButtonValues[1]</label>
    //          . . .
    //      <fieldset
    //  </div>
    //
    function makeRadioButtonsGroup(title, name, radioButtonValues) {
        let groupBox = makeDiv(name + "Group", "groupBox");
        let fieldset =  document.createElement('fieldset');
        groupBox.appendChild(fieldset);
        fieldset.appendChild(makeLegend(title,"groupBoxLegend"));
        for(let index in radioButtonValues)
        {
            let radioButton = makeRadioButton(name, index, radioButtonValues[index], "check-box");
            // Lorsqu'un bouton radio est changé transmettre l'événement au groupe
            radioButton.addEventListener("change",(e) => {
                let event = new Event('change');
                groupBox.dispatchEvent(event);
            });
            fieldset.appendChild(radioButton);
            fieldset.appendChild(makeLabelFor(radioButton.id, radioButtonValues[index], "radioButtonLabel"));
        }
       return groupBox;
    }

    //
    // <option value="value">value</option>
    //
    function makeOption(value){
        let option = document.createElement("option");
        option.value = value;
        option.textContent = value;
        return option;
    }

    //
    // <option value="" disabled selected>placeHolder</option>
    //
    function makeOptionPlaceHolder(placeHolder) {
        let option = document.createElement("option");
        option.value = "";
        option.textContent = placeHolder;
        option.disabled = true;
        option.selected = true;
        return option;
    }

    //
    // <select name="name" id ="name" class="cssClass">
    //      <option value="" disabled selected>placeHolder</option>
    //      <option value="values[0]">values[0]</option>
    //      <option value="values[1]">values[1]</option>
    //      . . .
    // </select>
    //
    function makeComboBox(name, values, placeHolder, cssClass){
        let comboBox = document.createElement('select');
        comboBox.name = name;
        comboBox.id = name;
        addClass(comboBox, cssClass);
        comboBox.appendChild(makeOptionPlaceHolder(placeHolder));
        values.forEach(value => { comboBox.appendChild(makeOption(value)); });
        return comboBox;
    }

    //
    // <form id="name" name="name" method="post"> </form>
    //
    function makeForm(name){
        let form =  document.createElement('form');
        form.method = "post";
        form.name= name;
        form.id = name;
        return form;
    }

    //
    // <input type="submit" value="title" class="cssClass" />
    //
    function makeSubmitButton(title, cssClass){
        let submitButton = document.createElement("input");
        submitButton.type="submit";
        submitButton.value = title;
        addClass(submitButton, cssClass);
        return submitButton;
    }

    //
    // utilisée par la classe ValidationProvider, détient la référence sur
    // un élément et sa méthode de validation. Affiche un message d'erreur
    // lorsque non valide.
    //
    class ValidationControl {
        constructor(elementId, validationTask) {
            // conserver l'élément à valider
            this.domElement = document.getElementById(elementId);
            if (this.domElement != null) {
                if (validationTask != undefined || validationTask != null) {
                    // conserver sa méthode de validation qui
                    // retourne une chaine vide si valide sinon un message d'erreur
                    this.validationTask = validationTask;
                    // insérér un message d'erreur masqué
                    if (this.domElement != null) {
                        this.errorIndicator = document.createElement("div");
                        this.errorIndicator.style.display = "none";
                        this.errorIndicator.style.color = "red";
                        this.errorIndicator.textContent = "test";
                        this.domElement.insertAdjacentElement("afterend", this.errorIndicator);
                    }
                }
                else {
                    console.log("ValidationControl: validationTask inexistant");
                }
            }
            else{
                console.log("ValidationControl: controlId inexistant");
            }
        }

        // démasquer le message d'erreur
        showError(message) {
            this.errorIndicator.style.display = "block";
            this.errorIndicator.textContent = message;
        }

        // masquer le message d'erreur
        hideError() {
            this.errorIndicator.style.display = "none";
        }

        // Mettre à jour la visibilité du message d'erreur
        // retourne vrai si valide
        isValid() {
            // vérifier la validité
            let errorMessage = this.validationTask();
            // mettre à jour la visibilité du message d'erreur
            if (errorMessage !== "") {
                this.showError(errorMessage);
            }
            else {
                this.hideError();
            }
            // un message d'erreur vide indique qu'il n'y a pas d'erreur
            return errorMessage === "";
        }
    }

    //
    // Automatiser la validation d'un ensemble d'éléments de formulaire
    //
    class ValidationProvider{
        constructor(formId) {
            // initialiser la liste de ValidationControl
            this.validationControls = [];
            // conserver la référence sur le formulaire
            this.form = document.getElementById(formId);
            // Ajouter un call back de l'événement submit au formulaire
            this.form.addEventListener("submit", (e) => { this.submit(e);});
        }

        isValid() {
            let formValid = true;
            this.validationControls.forEach( validationControl => {
                if (!validationControl.isValid()) {
                    formValid = false;
                }
            });
            return formValid;
        }

        // Call back de l'événement submit
        submit(e) {
            if (!this.isValid()) {
                // empêcher la soumission
                e.preventDefault();
            }
            else {
                // Cette portion qui indique que le formulaire est valide
                // est présente que pour des fins pédagogiques.
                // Il faudrait la retirer en production.
                alert("Formulaire valide");
            }
        }

        // Call back de l'événement change pour un des ValidationControls ciblé
        changed(e){
            this.validationControls.forEach((validationControl) => {
                if (validationControl.domElement.id === e.target.id) {
                    validationControl.isValid();
                }
            });
        }

        // ajout d'un ValidationControl
        // todo: ajouter la référence sur un tâche de validation à la soumission
        addControl(elementId, validationTask){
            let validationControl = new ValidationControl(elementId, validationTask);
            if (validationControl.domElement != null && (validationTask != undefined || validationTask != null)) {
                this.validationControls.push(validationControl);
                if (validationControl.domElement.tagName === "INPUT" || 
                    validationControl.domElement.tagName === "TEXTAREA") {
                    validationControl.domElement.addEventListener("input", (e) => { this.changed(e); });
                    validationControl.domElement.addEventListener("blur", (e) => { this.changed(e); });
                }
                else
                    validationControl.domElement.addEventListener("change", (e) => { this.changed(e); });
            }
        }
    }

    //////////////////////////////////////////////////////////////////////////////////////////////////
    // fonctions de validations des champs du formulaire.

    function validate_firstName(){
        let TBX_FirstName = document.getElementById("firstName");

        if (TBX_FirstName.value === "")
            return "Prénom manquant";
        
        return "";
    }

    function validate_lastName(){
        let TBX_LastName = document.getElementById("lastName");

        if (TBX_LastName.value === "")
            return "Nom manquant";

        return "";
    }

    function validate_email(){
        let TBX_Email = document.getElementById("email");
        let emailRegex = /^([\w\.\-]+)@([\w\-]+)((\.(\w){2,3})+)$/;

        if (!emailRegex.test(TBX_Email.value))
            return "Adresse de courriel invlaide";

        return "";
    }

    function validate_Password(){
        let TBX_Password = document.getElementById("password");

        if (TBX_Password.value === "")
            return "Mot de passe manquant";

        if (TBX_Password.value.length < 6) 
            return "Mot de passe trop court (6 caractères minimum)";

        return "";
    }

   function validate_PasswordConfirm(){
        let TBX_Confirm = document.getElementById("passwordConfirm");
        let TBX_Password = document.getElementById("password"); 

        if (TBX_Confirm.value === "")
            return "Confirmation du mot de passe manquant";

        if (TBX_Confirm.value !== TBX_Password.value)
            return "Ne correspond pas au mot de passe";

        return "";
    }

    function validate_language() {
        let comboBox = document.getElementById("language");

        if (comboBox.value === "")
            return "Veuillez sélectionner votre langue";
        
        return "";
    }

    function validate_Gender(){
        let radios = document.getElementsByName('sex');
        let oneChecked = false;

        for (let i = 0, length = radios.length; i < length; i++) {
            if (radios[i].checked) {
                oneChecked = true;
                break;
            }
        }

        if (!oneChecked)
            return "Veuillez sélectionner votre genre";

        return "";
    }

    //
    //////////////////////////////////////////////////////////////////////////////////////////////////////

    //
    // Call back de keypress pour retenir uniquement les caractères alphabétiques
    //
    function textInputAlphaFilter(event){
        // expression régulière pour accepter que les caractères alphabétiques
        let regExp = new RegExp("^[a-zA-Z-àÀâÂäÄçÇéÉèÈêÊëËìÌîÎïÏòÒôÔöÖùÙûÛüÜ '.''']+$");
        // saisir le caractère
        let key = String.fromCharCode(event.which );

        // si n'est pas un contrôle et backspace
        if ((event.which !== 0) && (event.which !== 8)) {
            // filtrer le caractère
            if (!regExp.test(key)) {
                // annuler la propagation de l'événement
                event.preventDefault();
            }
        }
    }

    //////////////////////////////////////////////////////////////////////////////////////////////////////




    //
    // Insertion du formulaire d'inscription et installation des validations
    //
    function insertSubscribeForm(parentPanel){

        let subscribeForm = makeForm("subscribeForm");

        subscribeForm.appendChild(makeTextBox("firstName","Prénom", "form-control"));
        subscribeForm.appendChild(document.createElement("br"));

        subscribeForm.appendChild(makeTextBox("lastName","Nom", "form-control"));
        subscribeForm.appendChild(document.createElement("br"));

        subscribeForm.appendChild(makeTextBox("email","Courriel", "form-control"));
        subscribeForm.appendChild(document.createElement("br"));

        subscribeForm.appendChild(makePasswordBox("password","Mot de passe", "form-control"));
        subscribeForm.appendChild(document.createElement("br"));

        subscribeForm.appendChild(makePasswordBox("passwordConfirm","Confirmation du mot de passe", "form-control"));
        subscribeForm.appendChild(document.createElement("br"));

        let languages = ["Fançais","Anglais","Espagnol","Allemand", "Italien", "Autre"];
        subscribeForm.appendChild(makeComboBox("language",languages,"Langue","form-control"));
        subscribeForm.appendChild(document.createElement("br"));

        let genders = ["Masculin", "Féminin", "Autre"];
        subscribeForm.appendChild(makeRadioButtonsGroup("Genre","sex", genders));
        subscribeForm.appendChild(document.createElement("br"));

        subscribeForm.appendChild(makeSubmitButton("Soumettre...","btn btn-primary"));
        subscribeForm.appendChild(document.createElement("br"));

        document.getElementById(parentPanel).appendChild(subscribeForm);

        // installer les validations du formulaire
        let validationProvider = new ValidationProvider("subscribeForm");
        validationProvider.addControl("firstName", validate_firstName);
        validationProvider.addControl("lastName", validate_lastName);
        validationProvider.addControl("email", validate_email);
        validationProvider.addControl("password", validate_Password);
        validationProvider.addControl("passwordConfirm", validate_PasswordConfirm);
        validationProvider.addControl("language", validate_language);
        validationProvider.addControl("sexGroup", validate_Gender);

        // installer des filtres
        document.getElementById("firstName").addEventListener("keypress", textInputAlphaFilter);
        document.getElementById("lastName").addEventListener("keypress", textInputAlphaFilter);
    }

    // au chargement du document html
    window.onload = () => { insertSubscribeForm("subscribeFormPanel");  };
</script>

</body>
</html>